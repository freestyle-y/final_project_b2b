<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.trade.mapper.DeliveryMapper">
	<!-- 배송 목록 조회(기업) -->
	<select id="selectBizDeliveryList" resultType="map">
		SELECT
			co.contract_no AS contractNo,
			a.address,
			a.detail_address AS detailAddress,
			cd.contract_delivery_time AS contractDeliveryTime,
			CASE cd.contract_delivery_status
				WHEN 'DS001' THEN '배송대기'
				WHEN 'DS002' THEN '배송중'
				WHEN 'DS003' THEN '배송완료'
			END AS contractDeliveryStatus
		FROM contract_delivery cd INNER JOIN address a ON cd.address_no = a.address_no
		INNER JOIN container ct ON cd.container_no = ct.container_no
		INNER JOIN contract_order co ON ct.contract_order_no = co.contract_order_no
	</select>
	
	<!-- 배송 상세 조회(개인) -->
	<select id="selectPersonalDeliveryBySubOrderNo" parameterType="com.example.trade.dto.DeliveryHistory" resultType="map">
		SELECT
			dh.delivery_company AS deliveryCompany,
			dh.tracking_no AS trackingNo,
			dh.update_date AS updateDate,
			ct.code_name AS deliveryStatus
		FROM delivery_history dh INNER JOIN comm_tbl ct ON dh.delivery_status = ct.code_number
		WHERE order_no = #{orderNo}
		AND sub_order_no = #{subOrderNo}
	</select>
	
	<!-- 교환/반품 신청 처리 -->
	<update id="updateExchangeReturn" parameterType="com.example.trade.dto.Order">
		UPDATE `order`
		<set>
			<if test="deliveryStatus == 'DS006'"> <!-- 교환 -->
				exchange_quantity = #{exchangeQuantity},
				exchange_reason = #{exchangeReason},
				exchange_request_time = NOW(),
				delivery_status = #{deliveryStatus},
			</if>
			<if test="deliveryStatus == 'DS004'"> <!-- 반품 -->
				return_quantity = #{returnQuantity},
				return_reason = #{returnReason},
				return_request_time = NOW(),
				delivery_status = #{deliveryStatus},
			</if>
			update_user = #{updateUser},
			update_date = NOW()
		</set>
		WHERE order_no = #{orderNo}
		AND sub_order_no = #{subOrderNo}
	</update>
</mapper>