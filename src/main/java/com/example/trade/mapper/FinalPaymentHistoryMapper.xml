<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.example.trade.mapper.FinalPaymentHistoryMapper">
	<!-- /com/example/trade/mapper/FinalPaymentHistoryMapper.xml -->
	<select id="getFinalList"
		resultType="com.example.trade.dto.Contract">
		SELECT
		c.down_payment AS downPayment
		, c.down_payment_date AS downPaymentDate
		, c.down_payment_status AS downPaymentStatus
		, c.final_payment AS finalPayment
		, c.final_payment_date AS finalPaymentDate
		, c.final_payment_status AS finalPaymentStatus
		, c.contract_no AS contractNo
		, ct.container_no AS containerNo
		, /* 최근 배송상태(없으면 NULL) */                          <!-- [수정] 추가 -->
		(SELECT cd3.contract_delivery_status
		FROM contract_delivery cd3
		WHERE cd3.container_no = ct.container_no
		ORDER BY cd3.contract_delivery_time DESC
		LIMIT 1) AS latestDeliveryStatus
		, /* 배송 입력 여부: 있으면 1, 없으면 0 */                 <!-- [수정] 추가 -->
		EXISTS (SELECT 1
		FROM contract_delivery cd2
		WHERE cd2.container_no = ct.container_no)
		AS deliveryExist
		FROM contract c
		LEFT JOIN container ct
		ON c.contract_no = ct.contract_order_no;
	</select>

</mapper>