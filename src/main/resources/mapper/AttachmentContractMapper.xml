<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.trade.mapper.AttachmentContractMapper">

    <!-- 첨부파일 등록 -->
    <insert id="insertAttachment" parameterType="com.example.trade.dto.Attachment">
        INSERT INTO attachment (
            attachment_code,
            category_code,
            priority,
            filepath,
            filename,
            create_user,
            create_date,
            use_status
        ) VALUES (
            #{attachmentCode},
            #{categoryCode},
            #{priority},
            #{filepath},
            #{filename},
            #{createUser},
            NOW(),
            #{useStatus}
        )
    </insert>

    <!-- 최대 우선순위 조회 -->
    <select id="selectMaxPriority" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(priority), 0)
        FROM attachment
        WHERE attachment_code = #{attachmentCode}
        AND category_code = #{categoryCode}
        AND use_status = 'Y'
    </select>

    <!-- 계약서별 첨부파일 목록 조회 -->
    <select id="selectAttachmentsByContract" resultType="com.example.trade.dto.Attachment">
        SELECT 
            attachment_no,
            attachment_code,
            category_code,
            priority,
            filepath,
            filename,
            create_user,
            create_date,
            update_user,
            update_date,
            use_status
        FROM attachment
        WHERE attachment_code = #{attachmentCode}
        AND category_code = #{contractNo}
        AND use_status = 'Y'
        ORDER BY priority ASC
    </select>

    <!-- 첨부파일 상세 조회 -->
    <select id="selectAttachmentByNo" resultType="com.example.trade.dto.Attachment">
        SELECT 
            attachment_no,
            attachment_code,
            category_code,
            priority,
            filepath,
            filename,
            create_user,
            create_date,
            update_user,
            update_date,
            use_status
        FROM attachment
        WHERE attachment_no = #{attachmentNo}
        AND use_status = 'Y'
    </select>

    <!-- 첨부파일 삭제 (논리 삭제) -->
    <update id="deleteAttachment">
        UPDATE attachment
        SET use_status = 'N',
            update_user = #{updateUser},
            update_date = NOW()
        WHERE attachment_no = #{attachmentNo}
    </update>
    
    <!-- 모든 첨부파일 조회 (디버깅용) -->
    <select id="selectAllAttachments" resultType="com.example.trade.dto.Attachment">
        SELECT 
            attachment_no,
            attachment_code,
            category_code,
            priority,
            filepath,
            filename,
            create_user,
            create_date,
            update_user,
            update_date,
            use_status
        FROM attachment
        WHERE use_status = 'Y'
        ORDER BY attachment_no DESC
    </select>

</mapper>
